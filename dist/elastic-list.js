function ElasticList(options){function genId(value){value=value.toString(),value=value.trim().toLowerCase();var i,chr,len,hash=0;if(0==value.length)return hash;for(i=0,len=value.length;len>i;i++)chr=value.charCodeAt(i),hash=(hash<<5)-hash+chr,hash|=0;return hash}function getKey(first,second){return genId(parseValue(first))+"X"+genId(parseValue(second))}function genColumnId(attr){return attr+"X"+genId(attr)}function parseValue(value){return null==value||"undefined"==typeof value||0==value.length?"Desconocido":value}function isIn(node,filters){var resp=!0;for(var key in filters)genId(parseValue(node[key]))!=genId(parseValue(filters[key]))&&(resp=!1);return resp}function getFilters(){var $filters=options.el.find(".active"),filters={};return $filters.each(function(){var key=$(this).parent().attr("data-name"),value=$(this).find(":not(.badge)").parent().attr("data-value");filters[key]=value}),filters}var grafo={},countMap={};return this.panelTemplate='<div class="panel panel-default "></div>',this.panelHeadTemplate='<div class="panel-heading"></div>',this.panelBodyTemplate='<div class="panel-body"/></div>',this.hideClass="hide-element",this.applyFilters=function($target){var nodes,map={},attrKey=null,filters=getFilters();for(var key in filters)attrKey=getKey(key,filters[key]);if(null==attrKey){this.el.find("li").removeClass(this.hideClass);for(var elId in countMap)this.el.find("#"+elId).text(countMap[elId]);return void("undefined"!=typeof options.onchange&&options.onchange({}))}nodes=grafo[attrKey],attrKey=attrKey.split("X");var attr=($target.find(".badge").attr("id"),attrKey[0]),key=attrKey[1];options.el.find("li:not(.active)").addClass(this.hideClass);for(var i=0;i<nodes.length;i++)if(isIn(nodes[i],filters))for(var j=0;j<options.columns.length;j++){var nodeKey=options.columns[j].attr,elId=getKey(nodeKey,nodes[i][nodeKey]),$el=$("#"+elId).parent(),count=this.count(map,elId,nodes[i]);nodeKey!=attr&&$el.removeClass(this.hideClass),$("#"+elId).text(count)}"undefined"==typeof options.onchange||"undefined"!=typeof this.settingDefault&&this.settingDefault||options.onchange(filters),this.settingDefault=!1},this.clickHandler=function(el){var $target=$(el),undo=!1,clazz=$target.attr("class");clazz.indexOf(this.hideClass)>=0||(clazz.indexOf("active")>=0?($target.removeClass("active"),undo=!0):($target.addClass("active"),$target.removeClass(this.hideClass)),"undefined"!=typeof this.hasFilter&&this.hasFilter&&this.el.find("input").each(function(){$(this).val("")}),this.applyFilters($target,undo))},this.setSelected=function(){if("undefined"!=typeof this.defaultValue)for(var attr in this.defaultValue){var value=this.defaultValue[attr];value=parseValue(value);var key=value.toString().toLowerCase(),elKey=getKey(attr,key),$target=$("#"+elKey);$target.length>0&&(this.settingDefault=!0,$target.parent().click())}},this.buildContainer=function(){var len="horizontal"===this.align?12:parseInt(12/this.columns.length),$container=$("<div class='list-container'></div>"),$input=$("<input type='text' class='elastic-filter'>"),$panel=$(this.panelTemplate);$container.addClass("col-md-"+len);for(var $head=$(this.panelHeadTemplate),j=($(this.panelBodyTemplate),0);j<this.columns.length;j++){var attr=this.columns[j].attr,$ulContainer=$container.clone(),$ulPanel=$panel.clone(),$ulhead=$head.clone();$ulhead.text(this.columns[j].title);var $ul=$("<ul class='list-group'></ul>");if($ul.attr("id",genColumnId(attr)),$ul.attr("data-name",attr),$ulPanel.append($ulhead),"undefined"!=typeof this.hasFilter&&this.hasFilter){var $ulFilter=$input.clone();$ulFilter.attr("placeholder",this.columns[j].title),$ulPanel.append($ulFilter);var $style=$("<style></style>");$style.attr("class",genColumnId(attr)),$ulPanel.append($style)}$ulPanel.append($ul),$ulContainer.append($ulPanel),this.el.append($ulContainer)}},this.count=function(countMap,key,node){var hasCountColumn="undefined"==typeof this.countColumn?!1:!0;return"undefined"==typeof countMap[key]?(countMap[key]=hasCountColumn?node[this.countColumn]:1,countMap[key]):(countMap[key]+=hasCountColumn?node[this.countColumn]:1,countMap[key])},this.buildList=function(){for(var count=0,i=0;i<this.data.length;i++)for(var j=0;j<this.columns.length;j++){var attr=this.columns[j].attr,value=this.data[i][attr];value=parseValue(value);var key=value.toString().toLowerCase(),elKey=getKey(attr,key);if("undefined"==typeof countMap[elKey]){count=this.count(countMap,elKey,this.data[i]),grafo[elKey]=[];var $ul=this.el.find("#"+genColumnId(attr)),$li=$("<li class='list-group-item'></li>"),$span=$("<div></div>"),$badge=$span.clone();$badge.addClass("badge"),$badge.attr("id",elKey),$badge.text(count),$li.attr("data-value",value.toString().toLowerCase()),"function"==typeof this.columns[j].formatter&&(value=this.columns[j].formatter(value)),$li.attr("data-formatted",value.toString().toLowerCase()),$span.text(value),$span.addClass("elastic-data"),$li.append($badge),$li.append($span),$ul.append($li)}else count=this.count(countMap,elKey,this.data[i]),this.el.find("#"+elKey).text(count);grafo[elKey].push(this.data[i])}},this.bindEvents=function(){var thiz=this;this.el.find("li").on("click",function(){thiz.clickHandler(this)}),"undefined"!=typeof this.hasFilter&&this.hasFilter&&this.el.find("input.elastic-filter").on("keyup",function(e){thiz.findData(e)})},this.findData=function(event){event.stopPropagation();var $input=$(event.target),$column=$input.parent().find("ul"),columnId=$column.attr("id"),data=$input.val().trim(),$style=this.el.find("."+columnId);if(data.length>0){data=data.toLocaleLowerCase();var rule=" ul#"+columnId+' li[data-formatted*="'+data+'"]{display:block;} ';rule+=" ul#"+columnId+' li:not([data-formatted*="'+data+'"]){display:none;}',$style.html(rule)}else $style.html("")},this.initialize=function(options){for(var attr in options)this[attr]=options[attr];this.buildContainer(),this.buildList(),this.bindEvents(),this.setSelected()},this.initialize(options),{getFilters:getFilters}}